import rasterio
import numpy as np
from rasterio.mask import mask
from pyproj import Transformer
from shapely.geometry import box, mapping

# ---------------- Function ----------------
def get_dn_from_rectangle(tif_file, lon, lat, width=10, height=12):
    with rasterio.open(tif_file) as src:
        # แปลงพิกัด (lon, lat WGS84) → CRS ของภาพ (UTM Zone 47N)
        transformer = Transformer.from_crs("EPSG:4326", src.crs, always_xy=True)
        x, y = transformer.transform(lon, lat)

        # สร้างกรอบสี่เหลี่ยมรอบพิกัด (10m x 12m)
        half_w, half_h = width/2, height/2
        rect = box(x - half_w, y - half_h, x + half_w, y + half_h)

        # ตัดภาพตาม polygon
        out_image, _ = mask(src, [mapping(rect)], crop=True)
        arr = out_image.astype(np.float32)

        # กำจัด nodata
        nod = src.nodata
        if nod is not None:
            mask_valid = arr != nod
        else:
            mask_valid = arr > 0

        # ค่าเฉลี่ย DN ต่อ band
        band_means = []
        for i in range(arr.shape[0]):
            valid = arr[i][mask_valid[i]]
            band_means.append(valid.mean() if valid.size > 0 else np.nan)

        # ชื่อแบนด์เรียงตาม DIMAP (Blue, Green, Red, NIR)
        band_names = ["blue", "green", "red", "nir"]
        dn_dict = {band_names[i]: band_means[i] for i in range(len(band_names))}

        return dn_dict

# ---------------- Run ----------------
tif_file = "IMAGERY.TIF"
lon, lat = 99.31819, 18.11402  # พิกัด

dn_mean = get_dn_from_rectangle(tif_file, lon, lat)

print("ค่าเฉลี่ย DN (10m x 12m):")
for b, val in dn_mean.items():
    print(f"{b.capitalize()}: {val:.2f}")
