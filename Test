import rasterio
from rasterio.windows import from_bounds
from pyproj import Transformer
import numpy as np

# -----------------------------
# พิกัดแปลง
lat, lon = 18.11302, 99.31819
width_m, height_m = 12, 10  # ขนาดแปลง

# path ไปยังภาพ THEOS-1
img_path = "THEOS_multiband.tif"

# -----------------------------
# เปิดภาพและดึง patch ของแปลง
with rasterio.open(img_path) as src:
    # แปลง lat/lon → CRS ของภาพ
    transformer = Transformer.from_crs("EPSG:4326", src.crs, always_xy=True)
    x, y = transformer.transform(lon, lat)
    
    # ขอบเขตของ patch (bounding box)
    half_w, half_h = width_m/2, height_m/2
    xmin, xmax = x-half_w, x+half_w
    ymin, ymax = y-half_h, y+half_h
    
    # สร้าง window
    window = from_bounds(xmin, ymin, xmax, ymax, transform=src.transform)
    patch = src.read(window=window).astype("float32")  # shape = (bands,H,W)
    
    # กรอง nodata
    if src.nodata is not None:
        patch = np.where(patch==src.nodata, np.nan, patch)

# -----------------------------
# คำนวณค่าเฉลี่ยแต่ละ band
band_names = ['Blue','Green','Red','NIR']
mean_bands = {name: np.nanmean(patch[i]) for i,name in enumerate(band_names)}

# -----------------------------
# แสดงผล
print("Mean value per band in 10x12m plot:", mean_bands)
