import rasterio
import numpy as np
from rasterio.windows import from_bounds
from pyproj import Transformer

# ------------------------------
# Input
# ------------------------------
tif_path = "your_image.tif"   # แก้เป็น path ของไฟล์ GeoTIFF
lat, lon = 18.11402, 99.31819
plot_width, plot_height = 10, 12  # ขนาดแปลง (เมตร)

# ------------------------------
# กำหนดค่า Gain และ Bias ของแต่ละ band
# ------------------------------
gains = {
    1: 1.46853,   # Blue
    2: 1.50071,   # Green
    3: 1.71019,   # Red
    4: 1.67119    # NIR
}
bias = {
    1: 0.0,
    2: 0.0,
    3: 0.0,
    4: 0.0
}

# ------------------------------
# เปิดไฟล์ GeoTIFF
# ------------------------------
with rasterio.open(tif_path) as src:
    # แปลงพิกัด lat/lon → UTM
    transformer = Transformer.from_crs("EPSG:4326", src.crs, always_xy=True)
    x, y = transformer.transform(lon, lat)

    # หาค่าขอบเขต (bounding box) 10m × 12m
    half_w, half_h = plot_width / 2, plot_height / 2
    xmin, xmax = x - half_w, x + half_w
    ymin, ymax = y - half_h, y + half_h

    # ดึง window ตาม bounding box
    window = from_bounds(xmin, ymin, xmax, ymax, src.transform)

    # อ่านค่าพิกเซลทุก band
    dn_values = []
    for b in range(1, src.count + 1):
        band = src.read(b, window=window).astype(float)
        # แปลง DN → Radiance (Gain * DN + Bias)
        band_cal = band * gains[b] + bias[b]
        # เก็บค่าเฉลี่ย
        dn_values.append(np.nanmean(band_cal))

# ------------------------------
# แสดงผลลัพธ์
# ------------------------------
print("ค่า DN เฉลี่ยทั้งแปลง (10m x 12m):")
print(f"Blue : {dn_values[0]:.4f}")
print(f"Green: {dn_values[1]:.4f}")
print(f"Red  : {dn_values[2]:.4f}")
print(f"NIR  : {dn_values[3]:.4f}")
