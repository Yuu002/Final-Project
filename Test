# app.py
from flask import Flask, render_template, request, jsonify
import ee

# Initialize GEE กับ Project จริง
ee.Initialize(project='map-web')

app = Flask(__name__)

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/get_image', methods=['POST'])
def get_image():
    data = request.json
    date = data.get('date')  # รูปแบบ 'YYYY-MM-DD'
    
    # ดึง Sentinel-2 (แนะนำรุ่นล่าสุด)
    collection = ee.ImageCollection('COPERNICUS/S2_SR') \
                    .filterDate(date, date) \
                    .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20)) \
                    .first()
    
    if collection:
        url = collection.getThumbURL({
            'min': 0,
            'max': 3000,
            'bands': ['B4','B3','B2'],
            'dimensions': 512
        })
        return jsonify({'url': url})
    else:
        return jsonify({'error': 'No image found for this date'}), 404

if __name__ == '__main__':
    app.run(debug=True)
--

<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
  <title>GEE + OpenLayers Example</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol/ol.css" />
  <script src="https://cdn.jsdelivr.net/npm/ol/ol.js"></script>
</head>
<body>
  <h3>เลือกวัน:</h3>
  <input type="date" id="datePicker">
  <br><br>
  <div id="map" style="width: 100%; height: 500px;"></div>

  <script>
    // สร้าง map
    const map = new ol.Map({
      target: 'map',
      layers: [
        new ol.layer.Tile({ source: new ol.source.OSM() })
      ],
      view: new ol.View({ center: ol.proj.fromLonLat([0,0]), zoom: 2 })
    });

    document.getElementById('datePicker').addEventListener('change', async function(){
        const date = this.value;
        const response = await fetch('/get_image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date })
        });
        const data = await response.json();
        if(data.url){
            // แสดง image overlay
            const imageLayer = new ol.layer.Image({
                source: new ol.source.ImageStatic({
                    url: data.url,
                    imageExtent: [-180, -90, 180, 90],
                    projection: 'EPSG:4326'
                })
            });
            map.getLayers().getArray().forEach((l, i)=>{
                if(i>0) map.removeLayer(l);  // ลบ layer เก่า
            });
            map.addLayer(imageLayer);
        }
    });
  </script>
</body>
</html>
