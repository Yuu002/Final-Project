import rasterio
from rasterio.windows import from_bounds
from pyproj import Transformer
import numpy as np

# -----------------------------
# 1️⃣ พิกัดและ patch size
lat, lon = 18.11302, 99.31819
width_m, height_m = 12, 10
img_path = "THEOS_multiband.tif"

# -----------------------------
# 2️⃣ ดึง patch
with rasterio.open(img_path) as src:
    transformer = Transformer.from_crs("EPSG:4326", src.crs, always_xy=True)
    x, y = transformer.transform(lon, lat)
    
    half_w, half_h = width_m/2, height_m/2
    xmin, xmax = x-half_w, x+half_w
    ymin, ymax = y-half_h, y+half_h
    
    window = from_bounds(xmin, ymin, xmax, ymax, transform=src.transform)
    patch = src.read(window=window).astype("float32")  # (bands,H,W)
    if src.nodata is not None:
        patch = np.where(patch==src.nodata, np.nan, patch)

# -----------------------------
# 3️⃣ แบ่ง patch เป็น subplots (เช่น 3x3)
bands, H, W = patch.shape
n_rows, n_cols = 3, 3
row_step = H // n_rows
col_step = W // n_cols

band_names = ['Blue','Green','Red','NIR']

# -----------------------------
# 4️⃣ Loop over subplots
subplot_stats = []
for i in range(n_rows):
    for j in range(n_cols):
        r_start = i*row_step
        r_end   = (i+1)*row_step if i<n_rows-1 else H
        c_start = j*col_step
        c_end   = (j+1)*col_step if j<n_cols-1 else W
        
        sub_patch = patch[:, r_start:r_end, c_start:c_end]
        
        # mean per band
        mean_bands = {name: np.nanmean(sub_patch[b]) for b,name in enumerate(band_names)}
        
        # vegetation indices
        blue, green, red, nir = sub_patch
        ndvi = (nir - red) / (nir + red + 1e-8)
        tndvi = (ndvi - np.nanmin(ndvi)) / (np.nanmax(ndvi) - np.nanmin(ndvi) + 1e-8)
        sr = nir / (red + 1e-8)
        L = 0.5
        savi = ((nir - red)/(nir + red + L))*(1+L)
        masvi2 = (nir - red)/(nir + red - blue + 1e-8)
        
        indices = {
            'NDVI': np.nanmean(ndvi),
            'TNDVI': np.nanmean(tndvi),
            'SR': np.nanmean(sr),
            'SAVI': np.nanmean(savi),
            'MASVI2': np.nanmean(masvi2)
        }
        
        subplot_stats.append({'row':i,'col':j,'mean_bands':mean_bands,'indices':indices})

# -----------------------------
# 5️⃣ แสดงผล
for stat in subplot_stats:
    print(f"Subplot (row {stat['row']}, col {stat['col']}):")
    print("  Mean Bands:", stat['mean_bands'])
    print("  Vegetation Indices:", stat['indices'])
    print()
