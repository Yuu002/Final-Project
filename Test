import rasterio
from rasterstats import zonal_stats
from shapely.geometry import box
from pyproj import Transformer
import geopandas as gpd

# --- ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏õ‡∏•‡∏á ---
lat, lon = 18.11302, 99.31819
width_m, height_m = 10, 12

# --- ‡πÅ‡∏õ‡∏•‡∏á lat/lon -> UTM (‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö CRS ‡∏†‡∏≤‡∏û) ---
transformer = Transformer.from_crs("EPSG:4326", "EPSG:32647", always_xy=True)
x_center, y_center = transformer.transform(lon, lat)

# --- ‡∏™‡∏£‡πâ‡∏≤‡∏á polygon ‡∏Ñ‡∏£‡∏≠‡∏ö‡πÅ‡∏õ‡∏•‡∏á ---
half_w, half_h = width_m / 2, height_m / 2
plot_poly = box(x_center - half_w, y_center - half_h,
                x_center + half_w, y_center + half_h)

gdf = gpd.GeoDataFrame({"id":[1]}, geometry=[plot_poly], crs="EPSG:32647")

# --- ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≠‡∏ö‡πÅ‡∏õ‡∏•‡∏á ---
raster_path = "IMAGERY.TIF"
stats = zonal_stats(gdf, raster_path, stats=["mean"], geojson_out=True, nodata=0)

# --- ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 4 bands ---
band_means = {}
if stats:
    props = stats[0]["properties"]
    band_means["Blue"] = props.get("mean_1")
    band_means["Green"] = props.get("mean_2")
    band_means["Red"] = props.get("mean_3")
    band_means["NIR"] = props.get("mean_4")

print("üìä ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≠‡∏ö‡πÅ‡∏õ‡∏•‡∏á (10x12 m):")
for k, v in band_means.items():
    print(f"{k}: {v:.4f}" if v is not None else f"{k}: None")
