<div class="section">
  <div class="section-title">Mode Selection</div>
  <div style="display:flex; gap:16px; margin-bottom:16px;">
    <label><input type="radio" name="mode" value="point" checked> Analyze Point (10x12)</label>
    <label><input type="radio" name="mode" value="area"> Analyze Area</label>
  </div>
</div>

let mode = 'point';
document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.addEventListener('change', e=>{
    mode = e.target.value;
    if(mode === 'area'){
      document.getElementById('lat').parentElement.style.display = 'none';
      document.getElementById('lon').parentElement.style.display = 'none';
      document.getElementById('getPixel').style.display = 'none';
    } else {
      document.getElementById('lat').parentElement.style.display = 'block';
      document.getElementById('lon').parentElement.style.display = 'block';
      document.getElementById('getPixel').style.display = 'block';
    }
  });
});

// Leaflet Draw สำหรับโหมด Area
let drawnItems = new L.FeatureGroup().addTo(map);
let drawControl = new L.Control.Draw({
  edit: { featureGroup: drawnItems },
  draw: {
    polygon: { allowIntersection: false },
    rectangle: true,
    marker: false,
    polyline: false,
    circle: false,
    circlemarker: false
  }
});
map.addControl(drawControl);

map.on(L.Draw.Event.CREATED, async function (e) {
  if(mode !== 'area') return;
  drawnItems.clearLayers();
  let layer = e.layer;
  drawnItems.addLayer(layer);
  let coords = layer.getLatLngs()[0].map(c => [c.lng, c.lat]);
  let start = document.getElementById('start').value;
  let end = document.getElementById('end').value;

  let resp = await fetch('/get_area', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({coords, start, end})
  });
  let pixel = await resp.json();

  function formatVal(val){ if(val==null) return '-'; return Number(val).toFixed(3);}
  document.getElementById('red').innerText   = formatVal(pixel['B4']);
  document.getElementById('green').innerText = formatVal(pixel['B3']);
  document.getElementById('blue').innerText  = formatVal(pixel['B2']);
  document.getElementById('nir').innerText   = formatVal(pixel['B8']);
  if(pixel.field_reflectance){
    document.getElementById('fblue').innerText  = formatVal(pixel.field_reflectance.Blue);
    document.getElementById('fgreen').innerText = formatVal(pixel.field_reflectance.Green);
    document.getElementById('fred').innerText   = formatVal(pixel.field_reflectance.Red);
    document.getElementById('fnir').innerText   = formatVal(pixel.field_reflectance.NIR);
  }
  if(pixel.indices){
    document.getElementById('ndvi').innerText  = formatVal(pixel.indices.NDVI);
    document.getElementById('tndvi').innerText = formatVal(pixel.indices.TNDVI);
    document.getElementById('sr').innerText    = formatVal(pixel.indices.SR);
    document.getElementById('savi').innerText  = formatVal(pixel.indices.SAVI);
    document.getElementById('msavi2').innerText= formatVal(pixel.indices.MSAVI2);
  }
  document.getElementById('agb').innerText = formatVal(pixel.AGB);
});
