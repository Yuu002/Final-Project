import rasterio
import geopandas as gpd
from shapely.geometry import box
from rasterstats import zonal_stats
from pyproj import Transformer

# -----------------------------
# 1. à¸žà¸²à¸£à¸²à¸¡à¸´à¹€à¸•à¸­à¸£à¹Œà¸ˆà¸²à¸à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰
# -----------------------------
lat = float(input("à¸à¸£à¸­à¸ Latitude (N): "))
lon = float(input("à¸à¸£à¸­à¸ Longitude (E): "))
width_m = float(input("à¸à¸£à¸­à¸à¸„à¸§à¸²à¸¡à¸à¸§à¹‰à¸²à¸‡à¸‚à¸­à¸‡à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆ (à¹€à¸¡à¸•à¸£): "))
height_m = float(input("à¸à¸£à¸­à¸à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§à¸‚à¸­à¸‡à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆ (à¹€à¸¡à¸•à¸£): "))

raster_path = "IMAGERY.TIF"  # à¹ƒà¸ªà¹ˆ path à¸‚à¸­à¸‡ raster à¸—à¸µà¹ˆà¸„à¸¸à¸“à¹ƒà¸Šà¹‰

# -----------------------------
# 2. à¹à¸›à¸¥à¸‡ lat/lon -> UTM à¸‚à¸­à¸‡ raster (EPSG:32647)
# -----------------------------
transformer = Transformer.from_crs("EPSG:4326", "EPSG:32647", always_xy=True)
x_center, y_center = transformer.transform(lon, lat)

# -----------------------------
# 3. à¸•à¸£à¸§à¸ˆ bounds à¸‚à¸­à¸‡ raster
# -----------------------------
with rasterio.open(raster_path) as src:
    raster_crs = src.crs
    bounds = src.bounds
    res_x, res_y = src.res

print(f"Raster bounds: {bounds}")
if not (bounds.left <= x_center <= bounds.right and bounds.bottom <= y_center <= bounds.top):
    raise ValueError("à¸žà¸´à¸à¸±à¸”à¸­à¸¢à¸¹à¹ˆà¸™à¸­à¸ bounds à¸‚à¸­à¸‡à¸ à¸²à¸ž!")

# -----------------------------
# 4. à¸ªà¸£à¹‰à¸²à¸‡ polygon à¸£à¸­à¸šà¸žà¸´à¸à¸±à¸”
# -----------------------------
half_w, half_h = width_m / 2, height_m / 2
xmin, xmax = x_center - half_w, x_center + half_w
ymin, ymax = y_center - half_h, y_center + half_h
plot_polygon = box(xmin, ymin, xmax, ymax)

gdf = gpd.GeoDataFrame({"id":[1]}, geometry=[plot_polygon], crs="EPSG:32647")

# -----------------------------
# 5. à¸„à¸³à¸™à¸§à¸“à¸„à¹ˆà¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¹à¸•à¹ˆà¸¥à¸° band
# -----------------------------
stats = zonal_stats(
    gdf,
    raster_path,
    stats=["mean"],
    all_touched=True,  # à¸£à¸§à¸¡ pixel à¸—à¸µà¹ˆ polygon à¹à¸•à¸°à¸‚à¸­à¸š
    nodata=None         # à¹ƒà¸Šà¹‰à¸„à¹ˆà¸² nodata à¸•à¸²à¸¡ raster
)

band_means = stats[0]["properties"]

# -----------------------------
# 6. à¸ˆà¸±à¸”à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¹ƒà¸«à¹‰à¸­à¹ˆà¸²à¸™à¸‡à¹ˆà¸²à¸¢
# -----------------------------
result = {
    "Blue (B1)": band_means.get("mean_1", None),
    "Green (B2)": band_means.get("mean_2", None),
    "Red (B3)": band_means.get("mean_3", None),
    "NIR (B4)": band_means.get("mean_4", None)
}

print("\nðŸ“Š à¸„à¹ˆà¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ Reflectance à¹ƒà¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆ {}m x {}m à¸£à¸­à¸šà¸žà¸´à¸à¸±à¸” ({}, {}):".format(width_m, height_m, lat, lon))
for band, value in result.items():
    print(f"{band}: {value}")
