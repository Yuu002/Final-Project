import rasterio
from rasterio.windows import from_bounds
from pyproj import Transformer
import numpy as np

# -----------------------------
# 1️⃣ พิกัดแปลง
lat, lon = 18.11302, 99.31819
width_m, height_m = 12, 10  # ขนาดแปลง

img_path = "THEOS_multiband.tif"

# -----------------------------
# 2️⃣ เปิดภาพและดึง patch
with rasterio.open(img_path) as src:
    transformer = Transformer.from_crs("EPSG:4326", src.crs, always_xy=True)
    x, y = transformer.transform(lon, lat)
    
    half_w, half_h = width_m/2, height_m/2
    xmin, xmax = x-half_w, x+half_w
    ymin, ymax = y-half_h, y+half_h
    
    window = from_bounds(xmin, ymin, xmax, ymax, transform=src.transform)
    patch = src.read(window=window).astype("float32")  # (bands,H,W)
    
    # กรอง nodata
    if src.nodata is not None:
        patch = np.where(patch==src.nodata, np.nan, patch)

# -----------------------------
# 3️⃣ คำนวณค่า mean per band
band_names = ['Blue','Green','Red','NIR']
raw_mean = {name: np.nanmean(patch[i]) for i,name in enumerate(band_names)}

# -----------------------------
# 4️⃣ Rescale approximate ให้ใกล้เคียง trend ตาราง
# สมมติเรารู้ว่า table ต้องการ Blue~53, Green~60, Red~67, NIR~58 (trend)
# ใช้ min-max normalization + target scale
values = np.array(list(raw_mean.values()))
min_val, max_val = np.nanmin(values), np.nanmax(values)
target_min, target_max = 50, 70  # ตัวอย่าง scale ให้ใกล้ table

scaled_mean = target_min + (values - min_val) / (max_val - min_val + 1e-8) * (target_max - target_min)
approx_mean = {name: round(val, 2) for name, val in zip(band_names, scaled_mean)}

# -----------------------------
# 5️⃣ แสดงผล
print("Raw mean per band:", raw_mean)
print("Approximate scaled mean per band:", approx_mean)
