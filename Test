from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
import ee

# Init Earth Engine
ee.Initialize()

app = FastAPI()

# allow frontend (Leaflet) to call API
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/gee/sentinel")
def get_sentinel(date: str):
    """ดึง Sentinel-2 ตามวันที่"""
    point = ee.Geometry.Point([100.5231, 13.7367])  # Bangkok center

    collection = ee.ImageCollection("COPERNICUS/S2") \
        .filterDate(date, date) \
        .filterBounds(point) \
        .median()

    vis = {"bands": ["B4", "B3", "B2"], "min": 0, "max": 3000}

    map_id_dict = ee.Image(collection).getMapId(vis)
    return {
        "mapid": map_id_dict["mapid"],
        "token": map_id_dict["token"]
    }
