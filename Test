import rasterio
import numpy as np
from rasterio.windows import from_bounds
from pyproj import Transformer

def get_dn_window(tif_file, lon, lat, width=10, height=12):
    with rasterio.open(tif_file) as src:
        transformer = Transformer.from_crs("EPSG:4326", src.crs, always_xy=True)
        x, y = transformer.transform(lon, lat)

        half_w, half_h = width/2, height/2
        xmin, xmax = x - half_w, x + half_w
        ymin, ymax = y - half_h, y + half_h

        # window จาก bounding box
        window = from_bounds(xmin, ymin, xmax, ymax, src.transform)

        dn_means = []
        for b in range(1, src.count+1):
            arr = src.read(b, window=window).astype(float)
            arr = arr[arr > 0]  # กำจัด nodata แบบง่าย ๆ
            dn_means.append(arr.mean() if arr.size > 0 else np.nan)

        return dict(zip(["blue", "green", "red", "nir"], dn_means))

# ใช้งาน
tif_file = "IMAGERY.TIF"
lon, lat = 99.31819, 18.11402
print(get_dn_window(tif_file, lon, lat))
