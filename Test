# bands_indices.py
import numpy as np

def compute_indices(src, row, col, width_m, height_m):
    """
    คำนวณค่า spectral bands และ indices
    src: rasterio dataset
    row, col: pixel center
    width_m, height_m: ขนาดพื้นที่ (เมตร)
    """
    # ---- Pixel resolution ----
    res_x, res_y = src.res  # ขนาด pixel (m)

    # ---- ขนาดเป็น pixel ----
    half_w_px = int((width_m / 2) / res_x)
    half_h_px = int((height_m / 2) / abs(res_y))

    r0 = max(0, row - half_h_px)
    r1 = min(src.height, row + half_h_px + 1)
    c0 = max(0, col - half_w_px)
    c1 = min(src.width, col + half_w_px + 1)

    # ---- Read all bands ----
    bands_data = src.read()  # shape: (bands, height, width)
    bands_dict = {}
    for i in range(bands_data.shape[0]):
        band = bands_data[i, r0:r1, c0:c1]
        bands_dict[f"Band_{i+1}"] = np.mean(band)

    # ---- Assume R=Band3, NIR=Band4 for indices ----
    R = bands_dict.get("Band_3")
    NIR = bands_dict.get("Band_4")
    L = 0.5

    indices_dict = {}
    indices_dict["NDVI"] = (NIR - R) / (NIR + R + 1e-6)
    indices_dict["TNDVI"] = np.sqrt((NIR - R)/(NIR + R + 1e-6) + L)
    indices_dict["SR"] = NIR / (R + 1e-6)
    indices_dict["SAVI"] = ((1 + L)*(NIR - R)) / (NIR + R + L + 1e-6)
    indices_dict["MSAVI2"] = (2*(NIR + 1) - np.sqrt((2*NIR + 1)**2 - 8*(NIR - R))) / 2

    return bands_dict, indices_dict
