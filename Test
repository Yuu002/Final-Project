# bands_indices.py
import rasterio
import numpy as np

def compute_bands_and_indices(raster_path):
    """
    อ่าน raster file และคำนวณ:
    - Spectral bands ทุก band ที่มี
    - 5 indices: NDVI, TNDVI, SR, SAVI, MSAVI2
    """
    bands_list = []
    
    # เปิด raster
    with rasterio.open(raster_path) as src:
        count = src.count
        for i in range(count):
            band = src.read(i+1).astype(float)
            bands_list.append(band)
    
    # เลือก Red และ NIR (สมมติ Red=band 3, NIR=band4 ถ้ามี)
    if count >= 4:
        R = bands_list[2]
        NIR = bands_list[3]
    else:
        raise ValueError("Raster ต้องมีอย่างน้อย 4 bands สำหรับ Red/NIR")
    
    # ค่า L สำหรับ TNDVI/SAVI
    L = 0.5
    
    # คำนวณ indices
    NDVI   = (NIR - R) / (NIR + R)
    TNDVI  = np.sqrt((NIR - R) / (NIR + R) + L)
    SR     = NIR / R
    SAVI   = ((1 + L) * (NIR - R)) / (NIR + R + L)
    MSAVI2 = (2 * NIR + 1 - np.sqrt((2 * NIR + 1)**2 - 8 * (NIR - R))) / 2
    
    indices_dict = {
        "NDVI": NDVI,
        "TNDVI": TNDVI,
        "SR": SR,
        "SAVI": SAVI,
        "MSAVI2": MSAVI2
    }
    
    return {
        "bands": bands_list,
        "indices": indices_dict
    }
