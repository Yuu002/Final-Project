import rasterio
import geopandas as gpd
from shapely.geometry import box
from rasterstats import zonal_stats
from pyproj import Transformer

# -----------------------------
# 1. พารามิเตอร์จากผู้ใช้
# -----------------------------
lat = float(input("กรอก Latitude (N): "))
lon = float(input("กรอก Longitude (E): "))
width_m = float(input("กรอกความกว้างของพื้นที่ (เมตร): "))
height_m = float(input("กรอกความยาวของพื้นที่ (เมตร): "))

raster_path = "IMAGERY.TIF"  # ใส่ path ของ raster ที่คุณใช้

# -----------------------------
# 2. แปลง lat/lon -> UTM ของ raster (EPSG:32647)
# -----------------------------
transformer = Transformer.from_crs("EPSG:4326", "EPSG:32647", always_xy=True)
x_center, y_center = transformer.transform(lon, lat)

# -----------------------------
# 3. ตรวจ bounds ของ raster
# -----------------------------
with rasterio.open(raster_path) as src:
    raster_crs = src.crs
    bounds = src.bounds
    res_x, res_y = src.res

print(f"Raster bounds: {bounds}")
if not (bounds.left <= x_center <= bounds.right and bounds.bottom <= y_center <= bounds.top):
    raise ValueError("พิกัดอยู่นอก bounds ของภาพ!")

# -----------------------------
# 4. สร้าง polygon รอบพิกัด
# -----------------------------
half_w, half_h = width_m / 2, height_m / 2
xmin, xmax = x_center - half_w, x_center + half_w
ymin, ymax = y_center - half_h, y_center + half_h
plot_polygon = box(xmin, ymin, xmax, ymax)

gdf = gpd.GeoDataFrame({"id":[1]}, geometry=[plot_polygon], crs="EPSG:32647")

# -----------------------------
# 5. คำนวณค่าเฉลี่ยแต่ละ band
# -----------------------------
stats = zonal_stats(
    gdf,
    raster_path,
    stats=["mean"],
    all_touched=True,  # รวม pixel ที่ polygon แตะขอบ
    nodata=None         # ใช้ค่า nodata ตาม raster
)

band_means = stats[0]["properties"]

# -----------------------------
# 6. จัดผลลัพธ์ให้อ่านง่าย
# -----------------------------
result = {
    "Blue (B1)": band_means.get("mean_1", None),
    "Green (B2)": band_means.get("mean_2", None),
    "Red (B3)": band_means.get("mean_3", None),
    "NIR (B4)": band_means.get("mean_4", None)
}

print("\n📊 ค่าเฉลี่ย Reflectance ในพื้นที่ {}m x {}m รอบพิกัด ({}, {}):".format(width_m, height_m, lat, lon))
for band, value in result.items():
    print(f"{band}: {value}")
