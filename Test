import rasterio
from rasterio.windows import from_bounds
from pyproj import Transformer
import numpy as np
import matplotlib.pyplot as plt

lat, lon = 18.11302, 99.31819
width_m, height_m = 12, 10
img_path = "THEOS_multiband.tif"

with rasterio.open(img_path) as src:
    transformer = Transformer.from_crs("EPSG:4326", src.crs, always_xy=True)
    x, y = transformer.transform(lon, lat)
    
    half_w, half_h = width_m/2, height_m/2
    xmin, xmax = x-half_w, x+half_w
    ymin, ymax = y-half_h, y+half_h
    
    window = from_bounds(xmin, ymin, xmax, ymax, transform=src.transform)
    patch = src.read(window=window).astype("float32")  # (bands,H,W)
    if src.nodata is not None:
        patch = np.where(patch==src.nodata, np.nan, patch)

# -----------------------------
# visualize RGB (bands: R=3,G=2,B=1)
rgb_patch = np.stack([patch[2], patch[1], patch[0]], axis=-1)
rgb_patch = np.nan_to_num(rgb_patch)
rgb_patch = rgb_patch / np.nanmax(rgb_patch)  # normalize 0-1

plt.imshow(rgb_patch)
plt.title("Patch RGB")
plt.show()
