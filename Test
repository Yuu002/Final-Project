import rasterio
from rasterio.windows import Window
from pyproj import Transformer
import numpy as np

# ---- 1) พิกัดตัวอย่าง ----
lat, lon = 18.11302, 99.31819

# ---- 2) ใส่ path ของไฟล์ THEOS-1 ----
band_paths = {
    "blue": "THEOS_Band1_Blue.tif",
    "green": "THEOS_Band2_Green.tif",
    "red": "THEOS_Band3_Red.tif",
    "nir": "THEOS_Band4_NIR.tif",
}

# ---- 3) ฟังก์ชันอ่านค่าเฉลี่ยจาก patch ----
def extract_patch_mean(band_path, row, col, half_size=2):
    with rasterio.open(band_path) as src:
        # window 5x5 pixel (≈ 20m x 20m ถ้า resolution 4m)
        window = Window(col - half_size, row - half_size,
                        2 * half_size + 1, 2 * half_size + 1)
        patch = src.read(1, window=window).astype("float32")
        # แปลง nodata เป็น NaN
        if src.nodata is not None:
            patch = np.where(patch == src.nodata, np.nan, patch)
        return np.nanmean(patch)

# ---- 4) หา pixel location จาก lat/lon ----
with rasterio.open(band_paths["red"]) as src_ref:
    print("CRS ของภาพ:", src_ref.crs)
    
    transformer = Transformer.from_crs("EPSG:4326", src_ref.crs, always_xy=True)
    x, y = transformer.transform(lon, lat)
    row, col = src_ref.index(x, y)
    print("Pixel location:", row, col)

# ---- 5) อ่านค่าเฉลี่ยทุก band ----
features = {}
for k, path in band_paths.items():
    features[k] = extract_patch_mean(path, row, col)

# ---- 6) คำนวณ NDVI ----
red = features["red"]
nir = features["nir"]
features["ndvi"] = (nir - red) / (nir + red + 1e-8)

print("Features ที่ได้:", features)
