# app.py
import streamlit as st
import pandas as pd
import rasterio
from pyproj import Transformer
from bands_indices import compute_indices  # ฟังก์ชันจากไฟล์แยก
import joblib

# ---- Load ML model ----
model = joblib.load("svr_agb_model.pkl")

st.title("AGB Prediction from Satellite Image")

# ---- Upload image ----
uploaded_file = st.file_uploader("Upload satellite image", type=["tif"])
if uploaded_file is not None:
    # Open raster
    src = rasterio.open(uploaded_file)
    raster_crs = src.crs
    width, height = src.width, src.height

    # ---- User input ----
    lat = st.number_input("Latitude (N)")
    lon = st.number_input("Longitude (E)")
    width_m = st.number_input("Plot Width (m)")
    height_m = st.number_input("Plot Height (m)")

    if st.button("Compute AGB"):
        # ---- Transform lat/lon -> raster CRS ----
        transformer = Transformer.from_crs("EPSG:4326", raster_crs, always_xy=True)
        x, y = transformer.transform(lon, lat)

        # ---- Convert to pixel coordinates ----
        row, col = src.index(x, y)

        # ---- Compute bands and indices ----
        bands_dict, indices_dict = compute_indices(src, row, col, width_m, height_m)

        # ---- Prepare features for ML model ----
        feature_order = ["NDVI", "TNDVI", "SR", "SAVI", "MSAVI2"]
        X = [indices_dict[k] for k in feature_order]

        # ---- Predict AGB ----
        agb_pred = model.predict([X])[0]

        # ---- Show results ----
        st.subheader("Band values")
        st.table(pd.DataFrame([bands_dict]))

        st.subheader("Indices")
        st.table(pd.DataFrame([indices_dict]))

        st.subheader("Predicted AGB (ton/ha)")
        st.write(agb_pred)
