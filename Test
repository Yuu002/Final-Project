# --- spectral_indices.py ---

import rasterio
import numpy as np

def read_bands(raster_path):
    """
    โหลด raster และคืนค่า array ของทุก bands
    """
    with rasterio.open(raster_path) as src:
        bands = src.read()  # shape: (band_count, height, width)
        crs = src.crs
    return bands, crs

def get_pixel_values(bands, row, col):
    """
    คืนค่า pixel ของทุก band ที่ระบุ row, col
    """
    return bands[:, row, col]

def compute_indices(R, NIR, L=0.5):
    """
    คำนวณดัชนี NDVI, TNDVI, SR, SAVI, MSAVI2
    """
    eps = 1e-6
    NDVI = (NIR - R) / (NIR + R + eps)
    TNDVI = np.sqrt(((NIR - R) / (NIR + R + eps)) + L)
    SR = NIR / (R + eps)
    SAVI = ((1 + L) * (NIR - R)) / (NIR + R + L + eps)
    MSAVI2 = (2*(NIR + 1) - np.sqrt((2*NIR + 1)**2 - 8*(NIR - R))) / 2
    return {"NDVI": NDVI, "TNDVI": TNDVI, "SR": SR, "SAVI": SAVI, "MSAVI2": MSAVI2}

def get_indices_from_pixel(bands, red_band_idx, nir_band_idx, row, col):
    """
    ดึง pixel ของ Red/NIR จาก raster และคำนวณดัชนี
    """
    pixel = get_pixel_values(bands, row, col)
    R = pixel[red_band_idx]
    NIR = pixel[nir_band_idx]
    return compute_indices(R, NIR)
