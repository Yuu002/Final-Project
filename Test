import streamlit as st
import pandas as pd
import joblib
from compute_bands_indices import compute_bands_indices  # ฟังก์ชันหาค่า bands และ indices

# ---- Load ML model ----
model = joblib.load("svr_agb_model.pkl")

st.title("AGB Prediction App")

# ---- User input for image upload ----
uploaded_file = st.file_uploader("Upload satellite image", type=["tif", "tiff"])

# ---- User input for coordinates and plot size ----
lat_str = st.text_input("Latitude (N)", "0")
lon_str = st.text_input("Longitude (E)", "0")
width_m_str = st.text_input("Plot width (m)", "10")
height_m_str = st.text_input("Plot height (m)", "12")

# ---- Convert inputs to float ----
try:
    lat = float(lat_str)
    lon = float(lon_str)
    width_m = float(width_m_str)
    height_m = float(height_m_str)
except ValueError:
    st.error("กรอกค่าตัวเลขให้ถูกต้อง")
    lat = lon = width_m = height_m = None

if uploaded_file and lat is not None:
    # ---- Compute bands and indices ----
    bands, indices = compute_bands_indices(uploaded_file, lat, lon, width_m, height_m)

    # ---- Display Bands ----
    st.subheader("Spectral Bands")
    df_bands = pd.DataFrame(bands, index=[0]).T  # แปลงเป็นแนวตั้ง
    df_bands.columns = ["Value"]
    st.table(df_bands)

    # ---- Display Indices ----
    st.subheader("Vegetation Indices")
    df_indices = pd.DataFrame(indices, index=[0]).T  # แนวตั้ง
    df_indices.columns = ["Value"]
    st.table(df_indices)

    # ---- Predict AGB ----
    X = pd.DataFrame([list(indices.values())])  # indices 5 ตัว
    agb_pred = model.predict(X)[0]

    st.subheader("Predicted AGB (ton/ha)")
    st.markdown(f"<h2 style='color:green;'>{agb_pred:.3f}</h2>", unsafe_allow_html=True)
