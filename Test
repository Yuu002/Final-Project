<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Satellite Crop + Bands</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<style>#map { height:600px; }</style>
</head>
<body>
<h3>Satellite Crop + Bands</h3>
<label>Date: <input type="date" id="datePicker" value="2025-09-23"></label>
<div id="map"></div>
<pre id="output"></pre>

<script>
var map = L.map('map').setView([13.7367, 100.5231], 10);

// Satellite only
var satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Esri Satellite'
}).addTo(map);

// Boundaries overlay
var boundaryLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'OSM Boundaries'
});

// Layer toggle
var baseMaps = {
  "Satellite Only": satLayer,
  "Satellite + Boundaries": L.layerGroup([satLayer, boundaryLayer])
};
L.control.layers(baseMaps).addTo(map);

// Draw polygon
var drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);
var drawControl = new L.Control.Draw({ draw: { polygon: true }, edit: { featureGroup: drawnItems } });
map.addControl(drawControl);

function sendPolygon(polygonGeoJSON){
  const date = document.getElementById("datePicker").value;
  fetch("http://localhost:8000/get_bands", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ polygon: polygonGeoJSON, date: date })
  })
  .then(res=>res.json())
  .then(data=>{
    document.getElementById("output").textContent = JSON.stringify(data, null, 2);
  });
}

// Event: finished drawing
map.on(L.Draw.Event.CREATED, function(event){
    var layer = event.layer;
    drawnItems.addLayer(layer);
    sendPolygon(layer.toGeoJSON().geometry);
});

// Event: change date â†’ resend polygon
document.getElementById("datePicker").addEventListener("change", ()=>{
  drawnItems.eachLayer(layer=>{
    sendPolygon(layer.toGeoJSON().geometry);
  });
});
</script>
</body>
</html>
