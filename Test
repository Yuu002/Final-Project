import streamlit as st
import rasterio
from rasterstats import zonal_stats
from shapely.geometry import box, mapping
from pyproj import Transformer

st.title("DN Zonal Mean Web App")

# 1. อัปโหลดไฟล์ GeoTIFF
tif_file = st.file_uploader("Upload GeoTIFF file", type=["tif", "tiff"])

if tif_file is not None:
    st.success("ไฟล์ถูกอัปโหลดแล้ว")

    # 2. กรอกพิกัดและขนาดพื้นที่
    lon = st.number_input("Longitude", value=99.31819)
    lat = st.number_input("Latitude", value=18.11402)
    width = st.number_input("ความกว้างพื้นที่ (m)", value=10.0)
    height = st.number_input("ความสูงพื้นที่ (m)", value=12.0)

    # 3. ฟังก์ชันคำนวณค่าเฉลี่ย DN (zonal mean)
    def get_band_means_zonal(tif_file_obj, lon, lat, width=10, height=12):
        with rasterio.open(tif_file_obj) as src:
            transformer = Transformer.from_crs("EPSG:4326", src.crs, always_xy=True)
            x, y = transformer.transform(lon, lat)
            half_w, half_h = width / 2, height / 2
            rect = box(x - half_w, y - half_h, x + half_w, y + half_h)
            
            band_names = ["blue", "green", "red", "nir"][:src.count]
            dn_means = {}
            for i, band_name in enumerate(band_names, start=1):
                stats = zonal_stats([mapping(rect)], tif_file_obj, stats=["mean"], band=i)
                dn_means[band_name] = stats[0]["mean"]
            return dn_means

    # 4. แสดงผล
    dn_means = get_band_means_zonal(tif_file, lon, lat, width, height)
    st.write("ค่าเฉลี่ย DN ของแต่ละ band:")
    for b, val in dn_means.items():
        st.write(f"{b.capitalize()}: {val:.2f}")
