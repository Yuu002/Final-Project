# app.py
import streamlit as st
from streamlit_folium import st_folium
import folium
from folium.plugins import Draw
import datetime
import os

st.set_page_config(layout="wide", page_title="Hybrid Map: ESRI + NDVI Overlay")

st.sidebar.title("Biomass Prediction Portal (Prototype)")
st.sidebar.markdown("เลือกวัน/เดือน/ปี เพื่อเปลี่ยน Overlay (NDVI/AGB)")

# --- Widget เลือกวัน
date_selected = st.sidebar.date_input("เลือกวันที่", datetime.date(2025, 1, 1))
date_str = date_selected.strftime("%Y-%m-%d")

# --- Base map (ESRI imagery)
start_coords = (13.5, 100.5)
m = folium.Map(location=start_coords, zoom_start=6, control_scale=True, tiles=None)

folium.TileLayer(
    tiles="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    attr="Esri World Imagery",
    name="Esri Satellite",
    overlay=False,
    control=True
).add_to(m)

folium.TileLayer("OpenStreetMap", name="OpenStreetMap").add_to(m)

# --- Overlay (ตัวอย่าง: NDVI PNG ไฟล์ที่เตรียมไว้)
# Path ตัวอย่าง: ./data/ndvi_YYYY-MM-DD.png
overlay_path = f"data/ndvi_{date_str}.png"

if os.path.exists(overlay_path):
    # Bounding box (ต้องเป็นพิกัดจริงของภาพที่คุณมี: [south, west, north, east])
    bounds = [[5, 97], [21, 106]]  # ตัวอย่างครอบประเทศไทย
    folium.raster_layers.ImageOverlay(
        name=f"NDVI {date_str}",
        image=overlay_path,
        bounds=bounds,
        opacity=0.6,
        interactive=True,
        cross_origin=False,
        zindex=1,
    ).add_to(m)
else:
    st.warning(f"ไม่มีไฟล์ overlay สำหรับ {date_str}")

# --- Layer control
folium.LayerControl().add_to(m)

# --- Draw tools
draw = Draw(
    export=True,
    position="topleft",
    draw_options={
        'polyline': False,
        'rectangle': True,
        'polygon': True,
        'circle': False,
        'marker': False,
        'circlemarker': False,
    },
    edit_options={'edit': True}
)
draw.add_to(m)

# --- Show map
st.write(f"### Hybrid Map — Base: Esri, Overlay: NDVI ({date_str})")
map_data = st_folium(m, width=1000, height=700)

# --- Draw results
st.write("---")
st.write("### ผลการวาด / ข้อมูลพื้นที่")
if map_data and "all_drawings" in map_data and map_data["all_drawings"]:
    drawings = map_data["all_drawings"]
    st.success(f"พบ {len(drawings)} พื้นที่ที่วาด")
    for i, d in enumerate(drawings):
        st.write(f"**พื้นที่ {i+1}**")
        st.json(d)
else:
    st.info("ยังไม่มีการวาดพื้นที่")
