import rasterio
from rasterstats import zonal_stats
from shapely.geometry import box, mapping
from pyproj import Transformer

def get_band_means_zonal(tif_file, lon, lat, width=10, height=12):
    # เปิดไฟล์ raster
    with rasterio.open(tif_file) as src:
        # แปลงพิกัด WGS84 → CRS ของภาพ
        transformer = Transformer.from_crs("EPSG:4326", src.crs, always_xy=True)
        x, y = transformer.transform(lon, lat)

        # สร้าง polygon สี่เหลี่ยมรอบพิกัด (width x height)
        half_w, half_h = width/2, height/2
        rect = box(x - half_w, y - half_h, x + half_w, y + half_h)

        # คำนวณค่าเฉลี่ย per band
        band_names = ["blue", "green", "red", "nir"][:src.count]
        dn_means = {}
        for i, band_name in enumerate(band_names, start=1):
            stats = zonal_stats([mapping(rect)], tif_file, stats=["mean"], band=i)
            dn_means[band_name] = stats[0]["mean"]

        return dn_means

# ---------------- Run ----------------
tif_file = "IMAGERY.TIF"
lon, lat = 99.31819, 18.11402

dn_means = get_band_means_zonal(tif_file, lon, lat)
print("ค่าเฉลี่ย DN ของแต่ละ band (10m x 12m):")
for b, val in dn_means.items():
    print(f"{b.capitalize()}: {val:.2f}")
