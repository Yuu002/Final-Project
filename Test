import rasterio
import numpy as np
from rasterio.mask import mask
from pyproj import transform
from shapely.geometry import box, mapping

# ---------------- Function: ค่าเฉลี่ย DN แบบ window ----------------
def values_from_window(src, lon, lat, window=1):
    # แปลง lat/lon -> CRS ของภาพ
    xs, ys = transform('EPSG:4326', src.crs, [lon], [lat])
    x, y = xs[0], ys[0]

    # หาตำแหน่ง pixel (row, col)
    row, col = src.index(x, y)

    # สร้าง window
    w = window
    window_data = src.read(window=(col - w, row - w, col + w + 1, row + w + 1))

    # กำจัด nodata
    nod = src.nodata
    if nod is not None:
        mask_valid = window_data != nod
    else:
        mask_valid = window_data > 0

    band_means = []
    for i in range(window_data.shape[0]):
        valid = window_data[i][mask_valid[i]]
        if valid.size == 0:
            band_means.append(np.nan)
        else:
            band_means.append(valid.mean())
    return np.array(band_means)

# ---------------- Function: ค่าเฉลี่ย DN แบบ rectangle (พื้นที่จริง) ----------------
def values_from_rectangle(src, lon, lat, width=10, height=12):
    # แปลง lat/lon -> CRS ของภาพ
    xs, ys = transform('EPSG:4326', src.crs, [lon], [lat])
    x, y = xs[0], ys[0]

    # สร้าง polygon (rectangle) รอบจุด (centered) ขนาด width x height (เมตร)
    half_w, half_h = width/2, height/2
    rect = box(x - half_w, y - half_h, x + half_w, y + half_h)

    # mask raster ด้วย polygon
    out_image, out_transform = mask(src, [mapping(rect)], crop=True)
    arr = out_image.astype(np.float32)

    # กำจัด nodata
    nod = src.nodata
    if nod is not None:
        mask_valid = arr != nod
    else:
        mask_valid = arr > 0

    # ค่าเฉลี่ย DN ต่อ band
    band_means = []
    for i in range(arr.shape[0]):
        valid = arr[i][mask_valid[i]]
        if valid.size == 0:
            band_means.append(np.nan)
        else:
            band_means.append(valid.mean())
    return np.array(band_means)

# ---------------- Example usage ----------------
tif_file = "your_image.tif"
lon, lat = 99.31819, 18.11402  # พิกัดตัวอย่าง

with rasterio.open(tif_file) as src:
    # 1) แบบ window
    dn_window = values_from_window(src, lon, lat, window=1)
    print("ค่าเฉลี่ย DN (3x3 window):", dn_window)

    # 2) แบบ rectangle
    dn_rect = values_from_rectangle(src, lon, lat, width=10, height=12)
    print("ค่าเฉลี่ย DN (พื้นที่ 10x12 m):", dn_rect)
