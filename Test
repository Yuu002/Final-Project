import rasterio
import geopandas as gpd
from shapely.geometry import box
from rasterstats import zonal_stats
from pyproj import Transformer
import pandas as pd

# --- Input ---
lat = float(input("‡∏Å‡∏£‡∏≠‡∏Å Latitude (N): "))
lon = float(input("‡∏Å‡∏£‡∏≠‡∏Å Longitude (E): "))
width_m = float(input("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏°‡∏ï‡∏£): "))
height_m = float(input("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏°‡∏ï‡∏£): "))

# --- ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û ---
raster_path = "IMAGERY.TIF"
with rasterio.open(raster_path) as src:
    raster_crs = src.crs
    res_x, res_y = src.res
    print(f"Resolution: {res_x} x {res_y} m/pixel")

# --- ‡πÅ‡∏õ‡∏•‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î lat/lon -> UTM ---
transformer = Transformer.from_crs("EPSG:4326", "EPSG:32647", always_xy=True)
x_center, y_center = transformer.transform(lon, lat)

# --- ‡∏™‡∏£‡πâ‡∏≤‡∏á polygon ‡∏Ç‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á ---
half_w, half_h = width_m/2, height_m/2
xmin, xmax = x_center - half_w, x_center + half_w
ymin, ymax = y_center - half_h, y_center + half_h
plot_polygon = box(xmin, ymin, xmax, ymax)

# --- ‡∏ó‡∏≥ GeoDataFrame ---
gdf = gpd.GeoDataFrame({"id":[1]}, geometry=[plot_polygon], crs="EPSG:32647")
gdf = gdf.to_crs(raster_crs)

# --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞ band ---
stats = zonal_stats(
    gdf,
    raster_path,
    stats=["mean"],
    nodata=0
)

band_means = stats[0]

# --- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
result = {
    "Blue (B1)": band_means.get("mean_1"),
    "Green (B2)": band_means.get("mean_2"),
    "Red (B3)": band_means.get("mean_3"),
    "NIR (B4)": band_means.get("mean_4")
}

print("\nüìä ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ Reflectance ‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà {}m x {}m ‡∏£‡∏≠‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î ({}, {}):".format(width_m, height_m, lat, lon))
print(pd.Series(result))
