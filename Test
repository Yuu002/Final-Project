import streamlit as st
import pandas as pd
import rasterio
from pyproj import Transformer
from bands_indices import compute_indices
import joblib

# ---- Load ML model ----
model = joblib.load("svr_agb_model.pkl")

st.title("AGB Prediction from Satellite Image")

# ---- Upload image ----
uploaded_file = st.file_uploader("Upload satellite image", type=["tif"])
if uploaded_file is not None:
    src = rasterio.open(uploaded_file)
    raster_crs = src.crs

    # ---- User input ----
    lat = st.number_input("Latitude (N)", value=0.0)
    lon = st.number_input("Longitude (E)", value=0.0)
    width_m = st.number_input("Plot Width (m)", value=10.0)
    height_m = st.number_input("Plot Height (m)", value=12.0)

    if st.button("Compute AGB"):
        # ---- Transform lat/lon -> raster CRS ----
        transformer = Transformer.from_crs("EPSG:4326", raster_crs, always_xy=True)
        x, y = transformer.transform(lon, lat)

        # ---- Convert to pixel coordinates ----
        row, col = src.index(x, y)

        # ---- Compute bands and indices ----
        bands_dict, indices_dict = compute_indices(src, row, col, width_m, height_m)

        # ---- Prepare features for ML model ----
        feature_order = ["NDVI", "TNDVI", "SR", "SAVI", "MSAVI2"]
        X = [indices_dict[k] for k in feature_order]

        # ---- Predict AGB ----
        agb_pred = model.predict([X])[0]

        # ---- Show results ----
        st.subheader("Band values")
        bands_df = pd.DataFrame(list(bands_dict.items()), columns=["Band", "Value"])
        st.dataframe(bands_df)

        st.subheader("Indices")
        indices_df = pd.DataFrame(list(indices_dict.items()), columns=["Index", "Value"])
        st.dataframe(indices_df)

        st.subheader("Predicted AGB (ton/ha)")
        # ตัวอักษรใหญ่ขึ้น
        st.markdown(f"<h1 style='color:green'>{agb_pred:.2f}</h1>", unsafe_allow_html=True)
