import rasterio
from rasterio.windows import from_bounds
from rasterio.warp import transform
import numpy as np

# -----------------------------
# 1. ใส่ path ของไฟล์ภาพดาวเทียมจริง (GeoTIFF 4 bands)
image_path = "your_image.tif"

# 2. พิกัดเป้าหมาย (lon, lat)
lon, lat = 99.31819, 18.11302

# 3. ขนาดพื้นที่ที่ต้องการ (เมตร)
width_m = 10
height_m = 12

# -----------------------------
with rasterio.open(image_path) as src:
    # แปลงพิกัด (lon/lat) → CRS ของภาพ
    xs, ys = transform("EPSG:4326", src.crs, [lon], [lat])
    x, y = xs[0], ys[0]

    # ความละเอียดภาพ (เมตร/พิกเซล)
    res_x = src.transform.a
    res_y = -src.transform.e  # เป็นค่าลบ ต้องกลับด้าน

    # ขนาด window (เป็นพิกเซล)
    win_w = int(round(width_m / res_x))
    win_h = int(round(height_m / res_y))

    # สร้าง bounding box รอบพิกัดเป้าหมาย
    half_w = (win_w * res_x) / 2
    half_h = (win_h * res_y) / 2
    xmin, xmax = x - half_w, x + half_w
    ymin, ymax = y - half_h, y + half_h

    # สร้าง window ตามพิกัด
    window = from_bounds(xmin, ymin, xmax, ymax, src.transform)

    # อ่านทุก band ใน window
    patch = src.read(window=window)

# -----------------------------
# patch.shape = (bands, rows, cols)
print("Shape:", patch.shape)

# คำนวณสถิติของแต่ละ band
for b in range(patch.shape[0]):
    arr = patch[b]
    mean_val = np.mean(arr)
    print(f"Band {b+1} ค่าเฉลี่ย = {mean_val:.2f}")
