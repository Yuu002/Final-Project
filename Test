import rasterio
import geopandas as gpd
from shapely.geometry import box
from pyproj import Transformer
from rasterstats import zonal_stats
import pandas as pd

# --------------------------
# üîπ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
# --------------------------
raster_path = "IMAGERY.TIF"   # ‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û THEOS1 ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
lat, lon = 18.11302, 99.31819  # ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏õ‡∏•‡∏á
width_m, height_m = 10, 12     # ‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏õ‡∏•‡∏á (‡πÄ‡∏°‡∏ï‡∏£)

# --------------------------
# üîπ 1) ‡πÅ‡∏õ‡∏•‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î lat/lon ‚Üí UTM (EPSG:32647)
# --------------------------
transformer = Transformer.from_crs("EPSG:4326", "EPSG:32647", always_xy=True)
x_center, y_center = transformer.transform(lon, lat)

# --------------------------
# üîπ 2) ‡∏™‡∏£‡πâ‡∏≤‡∏á polygon ‡∏Ç‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á (10√ó12 m)
# --------------------------
half_w, half_h = width_m/2, height_m/2
xmin, xmax = x_center - half_w, x_center + half_w
ymin, ymax = y_center - half_h, y_center + half_h
plot_polygon = box(xmin, ymin, xmax, ymax)

# --------------------------
# üîπ 3) ‡πÉ‡∏ä‡πâ zonal_stats ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ bands
# --------------------------
gdf = gpd.GeoDataFrame({"id":[1]}, geometry=[plot_polygon], crs="EPSG:32647")

stats = zonal_stats(
    gdf,
    raster_path,
    stats=["mean"],
    nodata=None  # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ nodata ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà None
)

# --------------------------
# üîπ 4) ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
# --------------------------
band_means = stats[0]  # dict ‡πÄ‡∏ä‡πà‡∏ô {'mean_1': 52.3, 'mean_2': 60.1, ...}

# ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
result = {f"Band {i+1}": band_means[f"mean_{i+1}"] for i in range(len(band_means))}
print("üìä ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞ Band ‡πÉ‡∏ô‡πÅ‡∏õ‡∏•‡∏á:")
print(pd.Series(result))
