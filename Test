import rasterio
import numpy as np

# --- 1. à¸•à¸±à¹‰à¸‡à¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œà¸ à¸²à¸žà¹„à¸§à¹‰à¸•à¸£à¸‡à¸™à¸µà¹‰à¹€à¸¥à¸¢ ---
raster_path = "IMAGERY.TIF"   # <<< à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œà¸ à¸²à¸žà¸—à¸µà¹ˆà¸„à¸¸à¸“à¸¡à¸µ

# --- 2. à¸à¸£à¸­à¸à¸„à¹ˆà¸²à¸žà¸´à¸à¸±à¸”à¹à¸¥à¸°à¸‚à¸™à¸²à¸”à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆ ---
lat = float(input("à¸à¸£à¸­à¸ Latitude (N): "))
lon = float(input("à¸à¸£à¸­à¸ Longitude (E): "))
width_m = float(input("à¸à¸£à¸­à¸à¸„à¸§à¸²à¸¡à¸à¸§à¹‰à¸²à¸‡à¸‚à¸­à¸‡à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆ (à¹€à¸¡à¸•à¸£): "))
height_m = float(input("à¸à¸£à¸­à¸à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§à¸‚à¸­à¸‡à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆ (à¹€à¸¡à¸•à¸£): "))

# --- 3. à¹€à¸›à¸´à¸”à¹„à¸Ÿà¸¥à¹Œà¸ à¸²à¸ž ---
with rasterio.open(raster_path) as src:
    print(f"\nà¸ˆà¸³à¸™à¸§à¸™ Bands à¹ƒà¸™à¸ à¸²à¸ž: {src.count}")
    print(f"Resolution: {src.res} à¹€à¸¡à¸•à¸£/à¸žà¸´à¸à¹€à¸‹à¸¥")
    print(f"CRS: {src.crs}\n")

    # --- 4. à¸«à¸²à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡ pixel à¸ˆà¸²à¸à¸žà¸´à¸à¸±à¸” ---
    row, col = src.index(lon, lat)

    # --- 5. à¸„à¸³à¸™à¸§à¸“à¸‚à¸­à¸šà¹€à¸‚à¸• window à¸•à¸²à¸¡à¸‚à¸™à¸²à¸”à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆ ---
    res_x, res_y = src.res
    half_w = int((width_m / res_x) / 2)
    half_h = int((height_m / abs(res_y)) / 2)

    r0 = max(0, row - half_h)
    r1 = min(src.height, row + half_h + 1)
    c0 = max(0, col - half_w)
    c1 = min(src.width, col + half_w + 1)

    # --- 6. à¸„à¸³à¸™à¸§à¸“à¸„à¹ˆà¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¹à¸•à¹ˆà¸¥à¸° band ---
    bands_mean = {}
    for b in range(1, src.count + 1):
        band = src.read(b)[r0:r1, c0:c1]
        band_mean = float(np.nanmean(band))
        bands_mean[f"Band_{b}"] = band_mean

# --- 7. à¹à¸ªà¸”à¸‡à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ ---
print("ðŸ“Š à¸„à¹ˆà¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ Reflectance à¸‚à¸­à¸‡à¹à¸•à¹ˆà¸¥à¸° Band:")
for band, mean_val in bands_mean.items():
    print(f"{band}: {mean_val:.4f}")
