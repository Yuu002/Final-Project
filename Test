from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
import ee

# Initialize GEE with Service Account
service_account = "YOUR_SERVICE_ACCOUNT@developer.gserviceaccount.com"
key_file = "gee_credentials.json"
credentials = ee.ServiceAccountCredentials(service_account, key_file)
ee.Initialize(credentials)

app = FastAPI()

# Allow frontend requests
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/gee/sentinel")
def get_sentinel(date: str):
    point = ee.Geometry.Point([100.5231, 13.7367])  # Bangkok

    collection = (
        ee.ImageCollection("COPERNICUS/S2")
        .filterDate(date, date)
        .filterBounds(point)
    )

    if collection.size().getInfo() == 0:
        return {"error": "No image for this date"}

    image = collection.median()
    vis = {"bands": ["B4", "B3", "B2"], "min": 0, "max": 3000}
    map_id_dict = ee.Image(image).getMapId(vis)

    return {"mapid": map_id_dict["mapid"], "token": map_id_dict["token"]}
