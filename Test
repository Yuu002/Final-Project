import rasterio
import numpy as np

# --- 1. ตั้งชื่อไฟล์ภาพไว้ตรงนี้เลย ---
raster_path = "IMAGERY.TIF"   # <<< ใส่ชื่อไฟล์ภาพที่คุณมี

# --- 2. กรอกค่าพิกัดและขนาดพื้นที่ ---
lat = float(input("กรอก Latitude (N): "))
lon = float(input("กรอก Longitude (E): "))
width_m = float(input("กรอกความกว้างของพื้นที่ (เมตร): "))
height_m = float(input("กรอกความยาวของพื้นที่ (เมตร): "))

# --- 3. เปิดไฟล์ภาพ ---
with rasterio.open(raster_path) as src:
    print(f"\nจำนวน Bands ในภาพ: {src.count}")
    print(f"Resolution: {src.res} เมตร/พิกเซล")
    print(f"CRS: {src.crs}\n")

    # --- 4. หาตำแหน่ง pixel จากพิกัด ---
    row, col = src.index(lon, lat)

    # --- 5. คำนวณขอบเขต window ตามขนาดพื้นที่ ---
    res_x, res_y = src.res
    half_w = int((width_m / res_x) / 2)
    half_h = int((height_m / abs(res_y)) / 2)

    r0 = max(0, row - half_h)
    r1 = min(src.height, row + half_h + 1)
    c0 = max(0, col - half_w)
    c1 = min(src.width, col + half_w + 1)

    # --- 6. คำนวณค่าเฉลี่ยแต่ละ band ---
    bands_mean = {}
    for b in range(1, src.count + 1):
        band = src.read(b)[r0:r1, c0:c1]
        band_mean = float(np.nanmean(band))
        bands_mean[f"Band_{b}"] = band_mean

# --- 7. แสดงผลลัพธ์ ---
print("📊 ค่าเฉลี่ย Reflectance ของแต่ละ Band:")
for band, mean_val in bands_mean.items():
    print(f"{band}: {mean_val:.4f}")
