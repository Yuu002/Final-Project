import rasterio
import numpy as np

def compute_bands_and_indices(raster_path, lat, lon, width_m, height_m):
    with rasterio.open(raster_path) as src:
        # ใช้ src เพื่อคำนวณ pixel row/col และค่า bands
        # ตัวอย่างง่าย ๆ:
        row, col = src.index(lon, lat)  # ปรับตาม CRS ของคุณ
        bands = src.read()[:, row, col]  # แก้เป็นการคำนวณเฉลี่ยถ้าต้องการ
        # ทำดัชนี
        R, G, B, NIR = bands[:4]
        L = 0.5
        NDVI = (NIR - R) / (NIR + R + 1e-6)
        TNDVI = np.sqrt(NDVI + L)
        SR = NIR / (R + 1e-6)
        SAVI = ((1+L)*(NIR - R)) / (NIR + R + L + 1e-6)
        MSAVI2 = (2*NIR + 1 - np.sqrt((2*NIR + 1)**2 - 8*(NIR - R))) / 2
        indices = {
            "NDVI": NDVI,
            "TNDVI": TNDVI,
            "SR": SR,
            "SAVI": SAVI,
            "MSAVI2": MSAVI2
        }
        bands_dict = {"R": R, "G": G, "B": B, "NIR": NIR}
        agb_pred = 10.0  # ตัวอย่าง placeholder ให้เอา model มาคำนวณจริง
        return bands_dict, indices, agb_pred
