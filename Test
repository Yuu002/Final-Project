import rasterio
import numpy as np
from pyproj import Transformer

def get_dn_nearest_pixel(tif_file, lon, lat):
    with rasterio.open(tif_file) as src:
        # แปลงพิกัด (lon, lat WGS84) → CRS ของภาพ (UTM Zone 47N)
        transformer = Transformer.from_crs("EPSG:4326", src.crs, always_xy=True)
        x, y = transformer.transform(lon, lat)

        # หาตำแหน่ง row, col ของ pixel
        row, col = src.index(x, y)

        # อ่านค่า DN ทุก band ที่ pixel นั้น
        dn_values = []
        for b in range(1, src.count + 1):
            arr = src.read(b)  # อ่านทั้ง band
            dn_values.append(arr[row, col])

        # ชื่อแบนด์เรียงตาม DIMAP
        band_names = ["blue", "green", "red", "nir"]
        return dict(zip(band_names, dn_values))

# ---------------- Run ----------------
tif_file = "IMAGERY.TIF"
lon, lat = 99.31819, 18.11402

dn_pixel = get_dn_nearest_pixel(tif_file, lon, lat)

print("ค่า DN จาก pixel ใกล้พิกัด:")
for b, val in dn_pixel.items():
    print(f"{b.capitalize()}: {val}")
