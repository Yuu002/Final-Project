import rasterio
from rasterio.windows import from_bounds
from pyproj import Transformer
import numpy as np

# -----------------------------
# 1️⃣ พิกัดและ patch size
lat, lon = 18.11302, 99.31819
width_m, height_m = 12, 10
img_path = "THEOS_multiband.tif"

# -----------------------------
# 2️⃣ ดึง patch
with rasterio.open(img_path) as src:
    transformer = Transformer.from_crs("EPSG:4326", src.crs, always_xy=True)
    x, y = transformer.transform(lon, lat)
    
    half_w, half_h = width_m/2, height_m/2
    xmin, xmax = x-half_w, x+half_w
    ymin, ymax = y-half_h, y+half_h
    
    window = from_bounds(xmin, ymin, xmax, ymax, transform=src.transform)
    patch = src.read(window=window).astype("float32")  # (bands,H,W)
    
    nodata_val = src.nodata
    if nodata_val is not None:
        patch = np.where(patch==nodata_val, np.nan, patch)

# -----------------------------
# 3️⃣ คำนวณค่าเฉลี่ยแต่ละ band (ทั้ง patch)
band_names = ['Blue','Green','Red','NIR']
mean_bands = {}
for b, name in enumerate(band_names):
    valid_pixels = patch[b][~np.isnan(patch[b])]
    mean_bands[name] = np.mean(valid_pixels) if valid_pixels.size > 0 else None

# -----------------------------
# 4️⃣ แสดงผล
print("Mean value per band in 10x12m patch:", mean_bands)
