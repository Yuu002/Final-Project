<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // --- Map initialization ---
  // ไม่ใส่ tileLayer basemap ใด ๆ เลย
  var map = L.map('map', {
    center: [19.2, 100.1],
    zoom: 10,
    zoomControl: true,
    attributionControl: false
  });

  var s2layer; // Sentinel-2 overlay

  // --- Load Map Button ---
  document.getElementById('loadMap').onclick = async function() {
    let start = document.getElementById('start').value;
    let end = document.getElementById('end').value;

    let resp = await fetch('/get_map', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({start, end})
    });
    let data = await resp.json();

    if(s2layer) map.removeLayer(s2layer);
    s2layer = L.tileLayer(data.tile_url).addTo(map);
    s2layer.bringToFront(); // บังคับให้ Sentinel-2 อยู่บนสุด
  };

  // --- Get Pixel Button ---
  document.getElementById('getPixel').onclick = async function() {
    let lat = parseFloat(document.getElementById('lat').value);
    let lon = parseFloat(document.getElementById('lon').value);
    let start = document.getElementById('start').value;
    let end = document.getElementById('end').value;

    if(isNaN(lat) || isNaN(lon)) {
      alert("Please enter valid coordinates!");
      return;
    }

    let resp = await fetch('/get_pixel', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({lat, lon, start, end})
    });

    let pixel = await resp.json();
    document.getElementById('coord').innerText = `Lat: ${lat}, Lon: ${lon}`;
    document.getElementById('red').innerText = `Red (B4): ${pixel['B4'] ?? '-'}`;
    document.getElementById('nir').innerText = `NIR (B8): ${pixel['B8'] ?? '-'}`;
  };

  // --- Click on Map to get Pixel ---
  map.on('click', async function(e){
    document.getElementById('lat').value = e.latlng.lat.toFixed(6);
    document.getElementById('lon').value = e.latlng.lng.toFixed(6);
    document.getElementById('getPixel').click();
  });
</script>
