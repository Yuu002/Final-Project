import streamlit as st
import pandas as pd
import tempfile
from bands_indices import compute_bands_and_indices  # ฟังก์ชันของคุณ

st.title("AGB Prediction App")

# ---- 1. Upload image ----
uploaded_file = st.file_uploader("Upload satellite image (.tif)", type=["tif", "tiff"])

# ---- 2. User input ----
lat = st.number_input("Latitude (N)", value=0.0, format="%.6f")
lon = st.number_input("Longitude (E)", value=0.0, format="%.6f")
width_m = st.number_input("Width of plot (m)", value=10.0)
height_m = st.number_input("Height of plot (m)", value=12.0)

if uploaded_file is not None:
    # ---- Save uploaded file temporarily ----
    with tempfile.NamedTemporaryFile(delete=False, suffix=".tif") as tmp_file:
        tmp_file.write(uploaded_file.read())
        tmp_path = tmp_file.name

    # ---- Compute bands and indices ----
    try:
        bands, indices, agb_pred = compute_bands_and_indices(
            tmp_path, lat, lon, width_m, height_m
        )

        # ---- Display bands vertically ----
        st.subheader("Bands")
        df_bands = pd.DataFrame(list(bands.items()), columns=["Band", "Value"])
        st.table(df_bands)

        # ---- Display indices vertically ----
        st.subheader("Indices")
        df_indices = pd.DataFrame(list(indices.items()), columns=["Index", "Value"])
        st.table(df_indices)

        # ---- Display predicted AGB ----
        st.subheader("Predicted AGB (ton/ha)")
        st.markdown(f"<h2 style='color:blue;'>{agb_pred:.2f}</h2>", unsafe_allow_html=True)

    except Exception as e:
        st.error(f"Error computing bands/indices: {e}")
