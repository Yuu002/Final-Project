from flask import Flask, render_template, request, jsonify
import ee

# Initialize Earth Engine
ee.Initialize(project='map-web-473508')

app = Flask(__name__)

# -----------------------------
# Cloud Mask Function (Sentinel-2 → DN → Rescale ใกล้ THEOS-1)
# -----------------------------
def mask_s2_clouds(image):
    qa = image.select('QA60')
    cloud_bit_mask = 1 << 10
    cirrus_bit_mask = 1 << 11
    mask = qa.bitwiseAnd(cloud_bit_mask).eq(0) \
           .And(qa.bitwiseAnd(cirrus_bit_mask).eq(0))
    
    # step 1: reflectance (0–10000) → DN (0–1023)
    dn_image = image.multiply(1023).divide(10000).toUint16()

    # step 2: linear rescale เพื่อใกล้กับ THEOS DN
    blue  = dn_image.select('B2').multiply(0.005).add(50)   # target ~48–55
    green = dn_image.select('B3').multiply(0.005).add(55)   # target ~55–60 (ประมาณ)
    red   = dn_image.select('B4').multiply(0.004).add(65)   # target ~64–67
    nir   = dn_image.select('B8').multiply(0.003).add(60)   # target ~58–62

    return blue.addBands([green, red, nir]).updateMask(mask)

# -----------------------------
# Route index.html
# -----------------------------
@app.route('/')
def index():
    return render_template('index.html')

# -----------------------------
# Endpoint ดึงแผนที่ Sentinel-2 → DN (rescaled)
# -----------------------------
@app.route('/get_map', methods=['POST'])
def get_map():
    start = request.json['start']
    end = request.json['end']

    collection = (ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
                  .filterDate(start, end)
                  .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20))
                  .map(mask_s2_clouds))

    image = collection.mean()

    vis_params = {
        'bands': ['B4', 'B3', 'B2'],  # Red, Green, Blue
        'min': 40,
        'max': 70,   # เพราะเรา rescale ให้ค่าช่วงนี้
        'gamma': 1.0
    }

    map_id_dict = ee.Image(image).getMapId(vis_params)
    tile_url = map_id_dict['tile_fetcher'].url_format

    return jsonify({'tile_url': tile_url})

# -----------------------------
# Endpoint ดึงค่า pixel (DN rescaled)
# -----------------------------
@app.route('/get_pixel', methods=['POST'])
def get_pixel():
    lat = float(request.json['lat'])
    lon = float(request.json['lon'])
    start = request.json['start']
    end = request.json['end']

    point = ee.Geometry.Point([lon, lat])

    collection = (ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
                  .filterDate(start, end)
                  .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20))
                  .map(mask_s2_clouds))

    image = collection.mean()  # pixel ตอนนี้เป็น DN rescaled (40–70)

    bands = image.reduceRegion(
        reducer=ee.Reducer.first(),
        geometry=point,
        scale=10
    )

    return jsonify(bands.getInfo())

# -----------------------------
if __name__ == '__main__':
    app.run(debug=True)
