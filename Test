import rasterio
from rasterio.mask import mask
import geopandas as gpd
import numpy as np

# --- THEOS-1 multiband image
img_path = "THEOS_multiband.tif"

# --- Shapefile ของแปลง (Polygon)
shp_path = "plots.shp"
plots = gpd.read_file(shp_path)

# --- เปิดภาพ
with rasterio.open(img_path) as src:
    mean_per_plot = []
    
    for idx, plot in plots.iterrows():
        geometry = [plot['geometry']]  # ต้องเป็น list ของ shapely geometry
        
        # mask ภาพให้เหลือเฉพาะพื้นที่ Polygon
        out_image, out_transform = mask(src, geometry, crop=True, nodata=np.nan)
        # out_image.shape = (bands, H, W)
        
        # คำนวณ mean per band
        band_names = ['Blue','Green','Red','NIR']
        mean_bands = {name: np.nanmean(out_image[i]) for i,name in enumerate(band_names)}
        mean_per_plot.append({'plot_id': plot['id'], 'mean_bands': mean_bands})

# --- แสดงผล
for stat in mean_per_plot:
    print(f"Plot {stat['plot_id']}: {stat['mean_bands']}")
