// === Sample 1 pixel on map (Map click) ===
// ใช้: COPERNICUS/S2_SR_HARMONIZED
// วิธีใช้: run script แล้วคลิกที่จุดบนแผนที่ ผลลัพธ์จะแสดงใน UI panel ด้านขวา

// เลือกภาพ (ตัวอย่าง: ภาพที่ไม่มีเมฆมากสุดในช่วงที่ต้องการ)
var start = '2019-06-01';
var end = '2019-07-31';
var s2 = ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
          .filterDate(start, end)
          .filterBounds(Map.getCenter()) // ปรับถ้าต้องการพื้นที่เฉพาะ
          .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 30))
          .sort('CLOUDY_PIXEL_PERCENTAGE')
          ;

// เอาภาพแรก (ประกอบการสาธิต)
var image = ee.Image(s2.first());
if (!image) {
  print('No image found for given filters. ปรับช่วงวันที่หรือเงื่อนไข cloud.');
} else {
  // แสดงภาพ (true color)
  Map.addLayer(image, {bands: ['B4','B3','B2'], min: 0, max: 3000}, 'S2 true color');
  Map.centerObject(image, 10);
}

// UI panel สำหรับแสดงผล
var resultPanel = ui.Panel({
  style: {position: 'bottom-right', padding: '8px'}
});
resultPanel.add(ui.Label('Click on the map to sample 1 pixel (Sentinel-2 SR).'));
var outputLabel = ui.Label('');
resultPanel.add(outputLabel);
Map.add(resultPanel);

// ฟังก์ชันเมื่อคลิกแผนที่
Map.onClick(function(coords) {
  if (!image) {
    outputLabel.setValue('No image loaded.');
    return;
  }
  var pt = ee.Geometry.Point([coords.lon, coords.lat]);
  // เลือกแบนด์ที่ต้องการ (เปลี่ยนชื่อหากต้องการ)
  var bands = image.bandNames();
  // reduceRegion เพื่อนำค่าพิกเซลที่ตำแหน่งนั้น (scale = 10m)
  var reduction = image.reduceRegion({
    reducer: ee.Reducer.first(), // pixel เดียว -> ใช้ first() หรือ mean()
    geometry: pt,
    scale: 10,
    maxPixels: 1e13
  });

  // evaluate แล้วแสดงใน UI
  reduction.evaluate(function(res) {
    if (!res) {
      outputLabel.setValue('No data at this location (maybe outside image).');
      return;
    }
    // สร้างข้อความสวย ๆ
    var lines = ['Sample at: ' + coords.lat.toFixed(6) + ', ' + coords.lon.toFixed(6)];
    Object.keys(res).forEach(function(k) {
      var v = res[k];
      lines.push(k + ' : ' + v);
    });
    lines.push('หมายเหตุ: ค่าอาจถูกสเกล (e.g., หารด้วย 10000 เพื่อเป็น reflectance).');
    outputLabel.setValue(lines.join('\n'));
  });
});
